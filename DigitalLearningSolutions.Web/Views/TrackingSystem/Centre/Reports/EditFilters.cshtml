@inject IConfiguration Configuration
@using DigitalLearningSolutions.Web.Helpers
@using DigitalLearningSolutions.Web.Models.Enums
@using DigitalLearningSolutions.Web.ViewModels.TrackingSystem.Centre.Reports
@using Microsoft.Extensions.Configuration
@model EditFiltersViewModel

@{
  var errorHasOccurred = !ViewData.ModelState.IsValid;
  ViewData["Title"] = "Edit report filters";
  ViewData["Application"] = "Tracking System";
  ViewData["HeaderPath"] = $"{Configuration["AppRootPath"]}/TrackingSystem/Centre/Dashboard";
  ViewData["HeaderPathName"] = "Tracking System";
  var reportIntervalValue = (int)Model.ReportInterval;
  var courseSelected = Model.CustomisationId.HasValue;
  var categorySelected = Model.CourseCategoryId.HasValue;
}

@section NavMenuItems {
  <partial name="~/Views/TrackingSystem/Shared/_NavMenuItems.cshtml" />
}

<link rel="stylesheet" href="@Url.Content("~/css/trackingSystem/reports.css")">

<div class="nhsuk-grid-row">
  <div class="nhsuk-grid-column-full">
    @if (errorHasOccurred) {
      <vc:error-summary order-of-property-names="@(new[] {
                                                   nameof(Model.JobGroupId),
                                                   nameof(Model.CourseCategoryId),
                                                   nameof(Model.CustomisationId),
                                                   nameof(Model.StartDay),
                                                   nameof(Model.StartMonth),
                                                   nameof(Model.StartYear),
                                                   nameof(Model.EndDay),
                                                   nameof(Model.EndMonth),
                                                   nameof(Model.EndYear),
                                                   nameof(Model.ReportInterval) })" />
    }

    <h1 id="page-heading" class="nhsuk-heading-xl">Edit report filters</h1>
    <form class="nhsuk-u-margin-bottom-3" method="post" novalidate asp-action="EditFilters">

      <vc:select-list asp-for="@nameof(Model.JobGroupId)"
                      label="Choose job group filter"
                      value="@Model.JobGroupId.ToString()"
                      hint-text=""
                      deselectable="true"
                      css-class="nhsuk-u-width-one-half"
                      default-option="All"
                      select-list-options="@Model.JobGroupOptions" />

      @if (Model.CanFilterCourseCategories) {
        <div class="nhsuk-form-group">
          <fieldset class="nhsuk-fieldset" aria-describedby="course-course-category-hint">
            <div class="nhsuk-hint" id="course-course-category-hint">
              Choose whether to filter based on course or course category
            </div>

            <div class="nhsuk-radios nhsuk-radios--conditional">
              <div class="nhsuk-radios__item">
                <input name="@nameof(Model.FilterType)"
                       class="nhsuk-radios__input"
                       id="course-filter-type-1"
                       type="radio"
                       value="@CourseFilterType.Course"
                       aria-controls="conditional-course-filter-type-1"
                       aria-expanded="@(courseSelected ? "true" : "false")"
                       @(courseSelected ? "checked" : "")>
                <label class="nhsuk-label nhsuk-radios__label" for="course-filter-type-1">
                  Course
                </label>
              </div>
              <div class="nhsuk-radios__conditional @(courseSelected ? "" : "nhsuk-radios__conditional--hidden")" id="conditional-course-filter-type-1">

                <vc:select-list asp-for="@nameof(Model.CustomisationId)"
                                label="Choose a course"
                                value="@Model.CustomisationId.ToString()"
                                hint-text=""
                                deselectable="true"
                                css-class="nhsuk-u-width-one-half"
                                default-option="All"
                                select-list-options="@Model.CustomisationOptions" />

              </div>

              <div class="nhsuk-radios__item">
                <input name="@nameof(Model.FilterType)"
                       class="nhsuk-radios__input"
                       id="course-filter-type-2"
                       type="radio"
                       value="@CourseFilterType.CourseCategory"
                       aria-controls="conditional-course-filter-type-2"
                       aria-expanded="@(categorySelected ? "true" : "false")"
                       @(categorySelected ? "checked" : "")>
                <label class="nhsuk-label nhsuk-radios__label" for="course-filter-type-2">
                  Course category
                </label>
              </div>
              <div class="nhsuk-radios__conditional @(categorySelected ? "" : "nhsuk-radios__conditional--hidden")" id="conditional-course-filter-type-2">
                <vc:select-list asp-for="@nameof(Model.CourseCategoryId)"
                                label="Choose course category from the list below"
                                value="@Model.CourseCategoryId.ToString()"
                                hint-text=""
                                deselectable="true"
                                css-class="nhsuk-u-width-one-half"
                                default-option="All"
                                select-list-options="@Model.CourseCategoryOptions" />
              </div>
            </div>
          </fieldset>
        </div>
      } else {
        <input type="hidden" asp-for="FilterType" value="@CourseFilterType.CourseCategory" />
        <vc:select-list asp-for="@nameof(Model.CustomisationId)"
                        label="Choose a course filter"
                        value="@Model.CustomisationId.ToString()"
                        hint-text=""
                        deselectable="true"
                        css-class="nhsuk-u-width-one-half"
                        default-option="All"
                        select-list-options="@Model.CustomisationOptions" />
      }

      <vc:date-range-input id="date-range"
                           label="Reporting date range"
                           start-day-id="@nameof(Model.StartDay)"
                           start-month-id="@nameof(Model.StartMonth)"
                           start-year-id="@nameof(Model.StartYear)"
                           end-day-id="@nameof(Model.EndDay)"
                           end-month-id="@nameof(Model.EndMonth)"
                           end-year-id="@nameof(Model.EndYear)"
                           end-date-checkbox-id="@nameof(Model.EndDate)"
                           end-date-checkbox-label="End date"
                           css-class="date-range-css"
                           hint-text="The reporting in your centre starts on @Model.DataStart.ToString(DateHelper.StandardDateFormat). Please select any date range between that date and now."
                           end-date-checkbox-hint-text="Check this box to specify an end date. If left unchecked will display data until today." />

      <vc:select-list asp-for="@nameof(Model.ReportInterval)"
                      label="Report by"
                      value="@reportIntervalValue.ToString()"
                      hint-text=""
                      deselectable="false"
                      css-class="nhsuk-u-width-one-half"
                      default-option=""
                      select-list-options="@Model.ReportIntervalOptions" />

      <button class="nhsuk-button" type="submit" value="save">Apply filters</button>
      <vc:cancel-link asp-controller="Reports" asp-action="Index" />
    </form>
  </div>
</div>
